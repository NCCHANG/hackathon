<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cloud CGPA Calculator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-4 sm:p-8">
  <div class="container mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-xl space-y-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 text-center tracking-tight mb-4">Cloud CGPA Calculator</h1>
    <p class="text-center text-gray-600 mb-8 max-w-lg mx-auto">This version uses a cloud database to save your data automatically across sessions and devices.</p>

    <!-- Auth Section -->
    <div id="auth-section" class="space-y-4">
      <h2 class="text-2xl font-bold text-gray-800 text-center">Login to Save Your Data</h2>
      <div class="space-y-4 max-w-sm mx-auto p-6 bg-gray-50 rounded-lg shadow-inner">
        <div>
          <label for="email-input" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="email-input" placeholder="you@example.com"
                 class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
        </div>
        <div>
          <label for="password-input" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="password-input" placeholder="••••••••"
                 class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
          <button id="signup-btn"
                  class="flex-1 py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 transform hover:scale-105">
            Sign Up
          </button>
          <button id="login-btn"
                  class="flex-1 py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform hover:scale-105">
            Log In
          </button>
        </div>
      </div>
      <p id="auth-status" class="text-center text-sm font-medium text-gray-600"></p>
    </div>

    <!-- Main Calculator UI -->
    <div id="calculator-ui" class="hidden space-y-8">
      <!-- User Info -->
      <div class="flex flex-col sm:flex-row items-center justify-between bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200">
        <span id="user-info" class="text-gray-600 text-sm font-medium mb-2 sm:mb-0">Welcome!</span>
        <button id="logout-btn"
                class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-sm hover:bg-red-700 transition duration-150 transform hover:scale-105">
          Log Out
        </button>
      </div>

      <!-- ✨ NEW: AI – Auto-Fill Past Trimesters -->
      <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
        <h2 class="text-xl font-bold text-indigo-800 mb-2">AI: Auto-Fill Past Trimesters</h2>
        <p class="text-sm text-indigo-700 mb-4">
          Paste your transcript text. We’ll detect your <strong>last 12 months</strong> of trimester/semester summaries (GPA &amp; credits) and add them to “Past Semesters”.
        </p>
        <textarea id="past-tri-text" rows="4" placeholder="Paste transcript summary sections here…"
                  class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"></textarea>
        <div class="flex items-center gap-3 mt-3">
          <button id="extract-tri-btn"
                  class="py-2.5 px-5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
            Extract Past Trimesters
          </button>
          <span id="extract-tri-status" class="text-sm text-indigo-700"></span>
        </div>
      </div>

      <!-- Past Semesters -->
      <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Past Semesters</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-2 font-bold text-gray-700">
          <div class="col-span-2 sm:col-span-1">Semester Name</div>
          <div class="col-span-1 sm:col-span-1">GPA</div>
          <div class="col-span-1 sm:col-span-1">Credits</div>
          <div class="col-span-1 sm:col-span-1"></div>
        </div>
        <div id="past-semesters-container" class="space-y-4"></div>
        <button id="add-semester-btn"
                class="mt-6 w-full py-3 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
          + Add A Past Semester
        </button>
      </div>

      <!-- Current Semester Courses -->
      <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Current Semester Courses</h2>
        <div class="grid grid-cols-3 sm:grid-cols-4 gap-4 mb-2 font-bold text-gray-700">
          <div class="col-span-2 sm:col-span-1">Course Name</div>
          <div class="col-span-1 sm:col-span-1">Credits</div>
          <div class="col-span-2 sm:col-span-1">Grade</div>
          <div class="col-span-1 sm:col-span-1"></div>
        </div>
        <div id="courses-container" class="space-y-4"></div>
        <button id="add-course-btn"
                class="mt-6 w-full py-3 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
          + Add Another Course
        </button>
      </div>

      <!-- What If -->
      <div class="bg-blue-50 p-6 rounded-2xl shadow-inner border border-blue-200">
        <h2 class="text-xl font-bold text-blue-800 mb-4">What If Scenario Planner</h2>
        <p class="text-sm text-blue-700 mb-4">Play with different grades for your current courses to see the hypothetical impact on your GPA. This will not save to the cloud.</p>
        <button id="what-if-btn"
                class="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 transform hover:scale-105">
          Calculate "What If" Scenario
        </button>
        <div id="what-if-results" class="hidden mt-4 bg-white p-4 rounded-xl shadow-md space-y-2">
          <p class="text-sm font-medium text-gray-500">Hypothetical Semester GPA:</p>
          <p id="what-if-sem-gpa" class="text-2xl font-extrabold text-blue-600">--</p>
          <p class="text-sm font-medium text-gray-500">Hypothetical New CGPA:</p>
          <p id="what-if-cgpa" class="text-2xl font-extrabold text-blue-600">--</p>
        </div>
      </div>

      <!-- Target CGPA -->
      <div class="bg-gray-50 p-6 rounded-xl shadow-inner border border-gray-200">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Set a Goal</h2>
        <label for="target-cgpa" class="block text-sm font-medium text-gray-700 mb-1">Target CGPA</label>
        <input type="number" id="target-cgpa" placeholder="e.g., 3.80" step="0.01"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
      </div>

      <!-- Buttons -->
      <div class="pt-6 border-t border-gray-200">
        <div class="flex flex-col sm:flex-row gap-4">
          <button id="calculate-btn"
                  class="flex-1 py-4 px-6 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105">
            Calculate CGPA &amp; Strategy
          </button>
          <button id="save-btn"
                  class="flex-1 py-4 px-6 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105">
            Save to Cloud
          </button>
          <button id="clear-btn"
                  class="flex-1 py-4 px-6 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition duration-150 transform hover:scale-105">
            Clear All
          </button>
        </div>
      </div>

      <!-- Results -->
      <div id="results-section" class="hidden bg-white p-6 rounded-2xl shadow-xl border border-blue-200 space-y-6">
        <h2 class="text-2xl font-bold text-blue-700 text-center">Results &amp; Insights</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 text-center">
          <div class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-100">
            <p class="text-sm font-medium text-blue-500">Your Semester GPA</p>
            <p id="sem-gpa-result" class="text-4xl font-extrabold text-blue-600 mt-1">--</p>
          </div>
          <div class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-100">
            <p class="text-sm font-medium text-blue-500">Your New CGPA</p>
            <p id="cgpa-result" class="text-4xl font-extrabold text-blue-600 mt-1">--</p>
          </div>
          <div class="bg-blue-50 p-4 rounded-xl shadow-md border border-blue-100">
            <p class="text-sm font-medium text-blue-500">Required Semester GPA</p>
            <p id="required-gpa-result" class="text-4xl font-extrabold text-blue-600 mt-1">--</p>
          </div>
        </div>

        <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200">
          <h3 class="flex items-center text-lg font-bold text-yellow-800 mb-2">
            <svg class="h-6 w-6 mr-2 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>
            Strategic Advice
          </h3>
          <p id="insights-text" class="text-yellow-700 leading-relaxed">
            Based on your inputs, this is where you should focus your efforts.
          </p>
        </div>
      </div>

      <!-- Projections -->
      <div id="projections-section" class="hidden bg-gray-50 p-6 rounded-2xl shadow-xl border border-gray-200">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Future CGPA Projections</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
          <div class="p-4 rounded-lg bg-white shadow-md">
            <p class="text-sm font-medium text-gray-500">If your GPA is 2.5</p>
            <p id="proj-25-result" class="text-2xl font-bold text-gray-700 mt-1">--</p>
          </div>
          <div class="p-4 rounded-lg bg-white shadow-md">
            <p class="text-sm font-medium text-gray-500">If your GPA is 3.0</p>
            <p id="proj-30-result" class="text-2xl font-bold text-gray-700 mt-1">--</p>
          </div>
          <div class="p-4 rounded-lg bg-white shadow-md">
            <p class="text-sm font-medium text-gray-500">If your GPA is 3.5</p>
            <p id="proj-35-result" class="text-2xl font-bold text-gray-700 mt-1">--</p>
          </div>
          <div class="p-4 rounded-lg bg-white shadow-md">
            <p class="text-sm font-medium text-gray-500">If your GPA is 4.0</p>
            <p id="proj-40-result" class="text-2xl font-bold text-gray-700 mt-1">--</p>
          </div>
        </div>
      </div>

      <!-- Chart (placeholder) -->
      <div id="chart-section" class="hidden bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
        <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Grade Distribution</h2>
        <canvas id="gradeDistributionChart" class="max-w-xl mx-auto"></canvas>
      </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4">
      <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center space-y-4">
        <h3 id="message-title" class="text-xl font-bold text-gray-800"></h3>
        <p id="message-content" class="text-gray-600"></p>
        <div class="flex justify-center">
          <button id="message-close-btn"
                  class="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBqe2vF4mmXbAjuWIcV_zCfc7hgzTFKSNQ",
    authDomain: "cgpacalculator-44f45.firebaseapp.com",
    projectId: "cgpacalculator-44f45",
    storageBucket: "cgpacalculator-44f45.firebasestorage.app",
    messagingSenderId: "976052597181",
    appId: "1:976052597181:web:6147fa61a823a4f0c062d4",
    measurementId: "G-5LGEGPHLED"
  };
  const appId = firebaseConfig.projectId;

  let db, auth, userId;
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);

  // UI refs
  const authSection = document.getElementById('auth-section');
  const emailInput = document.getElementById('email-input');
  const passwordInput = document.getElementById('password-input');
  const signupBtn = document.getElementById('signup-btn');
  const loginBtn = document.getElementById('login-btn');
  const authStatus = document.getElementById('auth-status');
  const calculatorUi = document.getElementById('calculator-ui');
  const userInfoSpan = document.getElementById('user-info');
  const logoutBtn = document.getElementById('logout-btn');

  // NEW AI (past trimesters)
  const pastTriText = document.getElementById('past-tri-text');
  const extractTriBtn = document.getElementById('extract-tri-btn');
  const extractTriStatus = document.getElementById('extract-tri-status');

  // (Removed UI) – keep guards so code won’t crash if elements don’t exist
  const parseTranscriptBtn = document.getElementById('parse-transcript-btn');
  const transcriptText   = document.getElementById('transcript-text');
  const parseSpinner     = document.getElementById('parse-spinner');
  const parseText        = document.getElementById('parse-text');

  // Containers
  const pastSemestersContainer = document.getElementById('past-semesters-container');
  const addSemesterBtn = document.getElementById('add-semester-btn');
  const coursesContainer = document.getElementById('courses-container');
  const addCourseBtn = document.getElementById('add-course-btn');

  const targetCgpaInput = document.getElementById('target-cgpa');
  const calculateBtn = document.getElementById('calculate-btn');
  const saveBtn = document.getElementById('save-btn');
  const clearBtn = document.getElementById('clear-btn');
  const whatIfBtn = document.getElementById('what-if-btn');
  const whatIfResults = document.getElementById('what-if-results');
  const whatIfSemGpa = document.getElementById('what-if-sem-gpa');
  const whatIfCgpa = document.getElementById('what-if-cgpa');

  const resultsSection = document.getElementById('results-section');
  const semGpaResult = document.getElementById('sem-gpa-result');
  const cgpaResult = document.getElementById('cgpa-result');
  const requiredGpaResult = document.getElementById('required-gpa-result');
  const insightsText = document.getElementById('insights-text');
  const projectionsSection = document.getElementById('projections-section');
  const proj25Result = document.getElementById('proj-25-result');
  const proj30Result = document.getElementById('proj-30-result');
  const proj35Result = document.getElementById('proj-35-result');
  const proj40Result = document.getElementById('proj-40-result');

  const messageBox = document.getElementById('message-box');
  const messageTitle = document.getElementById('message-title');
  const messageContent = document.getElementById('message-content');
  const messageCloseBtn = document.getElementById('message-close-btn');

  // Message box
  function showMessage(title, content) {
    messageTitle.textContent = title;
    messageContent.textContent = content;
    messageBox.classList.remove('hidden');
    messageBox.classList.add('flex');
  }
  messageCloseBtn.addEventListener('click', () => {
    messageBox.classList.remove('flex');
    messageBox.classList.add('hidden');
  });

  // Row helpers
  function createSemesterRow(semName = '', semGpa = '', semCredits = '') {
    const row = document.createElement('div');
    row.className = 'semester-row grid grid-cols-2 sm:grid-cols-4 gap-4 items-center bg-gray-100 p-4 rounded-lg border border-gray-200';
    row.innerHTML = `
      <div class="col-span-2 sm:col-span-1">
        <input type="text" placeholder="Semester Name" value="${semName}" class="sem-name w-full p-2 border border-gray-300 rounded-lg">
      </div>
      <div class="col-span-1 sm:col-span-1">
        <input type="number" placeholder="GPA" value="${semGpa}" step="0.01" class="sem-gpa w-full p-2 border border-gray-300 rounded-lg">
      </div>
      <div class="col-span-1 sm:col-span-1">
        <input type="number" placeholder="Credits" value="${semCredits}" step="1" class="sem-credits w-full p-2 border border-gray-300 rounded-lg">
      </div>
      <div class="col-span-1 sm:col-span-1 flex justify-end">
        <button class="remove-semester-btn p-2 text-gray-400 hover:text-red-500 transition-colors duration-150">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg>
        </button>
      </div>
    `;
    pastSemestersContainer.appendChild(row);
    row.querySelector('.remove-semester-btn').addEventListener('click', () => {
      pastSemestersContainer.removeChild(row);
    });
  }

  function createCourseRow(courseName = '', creditHours = '', grade = '') {
    const row = document.createElement('div');
    row.className = 'course-row grid grid-cols-3 sm:grid-cols-4 gap-4 items-center';
    row.innerHTML = `
      <div class="col-span-2 sm:col-span-1">
        <input type="text" placeholder="Course Name" value="${courseName}" class="course-name w-full p-3 border border-gray-300 rounded-lg">
      </div>
      <div class="col-span-1 sm:col-span-1">
        <input type="number" placeholder="Credits" value="${creditHours}" step="1" class="credit-hours w-full p-3 border border-gray-300 rounded-lg">
      </div>
      <div class="col-span-2 sm:col-span-1">
        <select class="grade-input w-full p-3 border border-gray-300 rounded-lg">
          <option value="" disabled selected>Select Grade</option>
          <option value="A+">A+</option><option value="A">A</option><option value="A-">A-</option>
          <option value="B+">B+</option><option value="B">B</option><option value="B-">B-</option>
          <option value="C+">C+</option><option value="C">C</option><option value="C-">C-</option>
          <option value="D+">D+</option><option value="D">D</option>
          <option value="F">F</option>
        </select>
      </div>
      <div class="col-span-1 sm:col-span-1 flex justify-end">
        <button class="remove-course-btn p-2 text-gray-400 hover:text-red-500 transition-colors duration-150">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"/></svg>
        </button>
      </div>
    `;
    coursesContainer.appendChild(row);
    row.querySelector('.remove-course-btn').addEventListener('click', () => {
      coursesContainer.removeChild(row);
    });
  }

  // Auth flow
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      userId = user.uid;
      userInfoSpan.textContent = `You are logged in with ID: ${userId}`;
      authSection.classList.add('hidden');
      calculatorUi.classList.remove('hidden');
      listenForData();
    } else {
      userId = null;
      authSection.classList.remove('hidden');
      calculatorUi.classList.add('hidden');
      showMessage("Signed Out", "You have been signed out. Please log in to access your data.");
    }
  });

  signupBtn.addEventListener('click', async () => {
    const email = emailInput.value;
    const password = passwordInput.value;
    if (!email || !password) { authStatus.textContent = "Please enter both email and password."; return; }
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      authStatus.textContent = "Successfully created account! You are now logged in.";
      showMessage("Success!", "Account created. You are now logged in.");
    } catch (error) {
      console.error("Sign up failed:", error);
      authStatus.textContent = `Sign up failed: ${error.message}`;
      showMessage("Sign Up Failed", error.message);
    }
  });

  loginBtn.addEventListener('click', async () => {
    const email = emailInput.value;
    const password = passwordInput.value;
    if (!email || !password) { authStatus.textContent = "Please enter both email and password."; return; }
    try {
      await signInWithEmailAndPassword(auth, email, password);
      authStatus.textContent = "Successfully logged in!";
      showMessage("Success!", "You have been logged in.");
    } catch (error) {
      console.error("Login failed:", error);
      authStatus.textContent = `Login failed: ${error.message}`;
      showMessage("Login Failed", error.message);
    }
  });

  logoutBtn.addEventListener('click', () => { signOut(auth); });

  const listenForData = () => {
    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'cgpaData', 'myCgpaData');
    onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        loadData(docSnap.data());
        showMessage("Data Loaded", "Your data has been loaded from the cloud.");
      } else {
        showMessage("Welcome!", "No saved data found. Start by adding your past semesters and courses.");
        loadData({ semesters: [], courses: [] });
      }
    }, (error) => {
      console.error("Error getting document:", error);
      showMessage("Database Error", "Failed to load data from the cloud. Please check your connection.");
    });
  };

  // Save/Load helpers
  async function saveData() {
    if (!userId) { showMessage("Authentication Required", "Please log in before saving your data."); return; }
    const data = { targetCgpa: targetCgpaInput.value, semesters: [], courses: [] };

    document.querySelectorAll('.semester-row').forEach(row => {
      data.semesters.push({
        name: row.querySelector('.sem-name').value,
        gpa: row.querySelector('.sem-gpa').value,
        credits: row.querySelector('.sem-credits').value
      });
    });

    document.querySelectorAll('.course-row').forEach(row => {
      data.courses.push({
        name: row.querySelector('.course-name').value,
        credits: row.querySelector('.credit-hours').value,
        grade: row.querySelector('.grade-input').value
      });
    });

    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'cgpaData', 'myCgpaData');
    try {
      await setDoc(docRef, data);
      showMessage("Save Successful", "Your data has been saved to the cloud!");
    } catch (e) {
      console.error("Error adding document: ", e);
      showMessage("Save Failed", "Could not save your data. Please check your connection.");
    }
  }

  function loadData(data) {
    targetCgpaInput.value = '';
    pastSemestersContainer.innerHTML = '';
    coursesContainer.innerHTML = '';
    if (pastTriText) pastTriText.value = '';
    if (transcriptText) transcriptText.value = '';
    resultsSection.classList.add('hidden');
    projectionsSection.classList.add('hidden');
    whatIfResults.classList.add('hidden');

    targetCgpaInput.value = data.targetCgpa || '';
    if (data.semesters?.length) {
      data.semesters.forEach(sem => createSemesterRow(sem.name, sem.gpa, sem.credits));
    } else {
      createSemesterRow();
    }
    if (data.courses?.length) {
      data.courses.forEach(c => createCourseRow(c.name, c.credits, c.grade));
    } else {
      createCourseRow();
    }
  }

  // Buttons
  addSemesterBtn.addEventListener('click', () => createSemesterRow());
  addCourseBtn.addEventListener('click', () => createCourseRow());
  saveBtn.addEventListener('click', saveData);
  clearBtn.addEventListener('click', () => {
    pastSemestersContainer.innerHTML = '';
    coursesContainer.innerHTML = '';
    targetCgpaInput.value = '';
    if (transcriptText) transcriptText.value = '';
    if (pastTriText) pastTriText.value = '';
    resultsSection.classList.add('hidden');
    projectionsSection.classList.add('hidden');
    whatIfResults.classList.add('hidden');
  });

  // Grade map
  const gradePoints = {
    'A+': 4.0, 'A': 4.0, 'A-': 3.7,
    'B+': 3.3, 'B': 3.0, 'B-': 2.7,
    'C+': 2.3, 'C': 2.0, 'C-': 1.7,
    'D+': 1.3, 'D': 1.0,
    'F': 0.0
  };

  // (GUARDED) ORIGINAL AI PARSER (courses) – only wire up if the UI exists
  if (parseTranscriptBtn) {
    parseTranscriptBtn.addEventListener('click', async () => {
      const text = (transcriptText?.value || '').trim();
      if (!text) { showMessage("Input Required", "Please paste your transcript text into the box first."); return; }

      parseTranscriptBtn.disabled = true;
      if (parseSpinner) parseSpinner.classList.remove('hidden');
      if (parseText) parseText.textContent = 'Parsing...';

      try {
        const prompt = `You are a helpful assistant that extracts academic course information from raw text. The user will provide text from a university transcript or similar document. Your task is to identify and extract each course's name, credit hours, and letter grade.

Provide the extracted data as a JSON array of objects with keys: name (string), credits (number), grade (string A+/A/A-/.../F). If you cannot find a piece of information for a course, use null.

Now, process the following text:
"""
${text}
"""`;

        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = {
          contents: chatHistory,
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "ARRAY",
              items: {
                type: "OBJECT",
                properties: {
                  "name": { "type": "STRING" },
                  "credits": { "type": "NUMBER" },
                  "grade": { "type": "STRING" }
                }
              }
            }
          }
        };

        const apiKey = "AIzaSyBB476jafxuZ0LbQaboaiEoKpB0U4bK0Co";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

        const result = await response.json();
        const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!jsonString) throw new Error("API response was empty or malformed.");

        const parsedCourses = JSON.parse(jsonString);
        if (!Array.isArray(parsedCourses)) throw new Error("Parsed data is not an array.");

        coursesContainer.innerHTML = '';
        parsedCourses.forEach(course => {
          if (course?.name && course?.credits != null && course?.grade) {
            createCourseRow(course.name, course.credits, (course.grade || '').toUpperCase());
          }
        });

        showMessage("Success!", "Courses have been automatically added. Please review the details.");
      } catch (error) {
        console.error("Parsing failed:", error);
        showMessage("Parsing Failed", "There was an error parsing the text. Please ensure the text format is clear and try again, or enter the data manually.");
      } finally {
        parseTranscriptBtn.disabled = false;
        if (parseSpinner) parseSpinner.classList.add('hidden');
        if (parseText) parseText.textContent = 'Parse & Fill Courses';
      }
    });
  }

  // NEW AI PARSER (past trimesters)
  extractTriBtn.addEventListener('click', async () => {
    const text = pastTriText.value.trim();
    if (!text) { showMessage("Input Required", "Please paste transcript text first."); return; }

    extractTriBtn.disabled = true;
    extractTriStatus.textContent = "Extracting…";

    try {
      const triPrompt = `Extract past trimester/semester summaries from the transcript text.

Return a JSON array. Each item MUST have:
- "name" (string): a human-friendly label like "Trimester March/April 2024" or "Semester 2 2024/2025"
- "gpa" (number)
- "credits" (number, total credits/hours for that term)
- "endDate" (string, ISO date YYYY-MM-DD if you can infer; otherwise null)

Include only real trimesters/semesters, not course lines.

Transcript:
"""
${text}
"""`;

      const chatHistory = [{ role: "user", parts: [{ text: triPrompt }] }];
      const payload = {
        contents: chatHistory,
        generationConfig: {
          responseMimeType: "application/json",
          responseSchema: {
            type: "ARRAY",
            items: {
              type: "OBJECT",
              properties: {
                "name": { "type": "STRING" },
                "gpa": { "type": "NUMBER" },
                "credits": { "type": "NUMBER" },
                "endDate": { "type": "STRING" }
              }
            }
          }
        }
      };

      const apiKey = "AIzaSyBB476jafxuZ0LbQaboaiEoKpB0U4bK0Co";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);

      const result = await response.json();
      const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!jsonString) throw new Error("No JSON returned by model.");

      let terms = JSON.parse(jsonString);
      if (!Array.isArray(terms)) throw new Error("Model output was not an array.");

      // Filter to ~past 12 months when endDate is available
      const now = new Date();
      const cutoff = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
      terms = terms.filter(t => {
        if (t?.endDate) {
          const d = new Date(t.endDate);
          return !isNaN(d) ? d >= cutoff : true;
        }
        return true;
      });

      if (terms.length === 0) {
        showMessage("No Recent Terms", "Couldn’t find trimester/semester summaries from the last 12 months. You can still add them manually.");
      }

      terms.forEach(t => {
        const name = t?.name || 'Trimester/Semester';
        const gpa = (typeof t?.gpa === 'number' ? t.gpa.toFixed(2) : '');
        const credits = (typeof t?.credits === 'number' ? t.credits : '');
        createSemesterRow(name, gpa, credits);
      });

      extractTriStatus.textContent = terms.length ? `Added ${terms.length} term(s).` : 'No terms added.';
    } catch (err) {
      console.error(err);
      showMessage("Extraction Failed", "We couldn’t extract trimester summaries. Try pasting the transcript sections that include term GPA and total credits/hours.");
      extractTriStatus.textContent = '';
    } finally {
      extractTriBtn.disabled = false;
    }
  });

  // Calculations (fixed to skip empty past-semester rows)
  function performCalculations() {
    let prevTotalGpXCh = 0;
    let prevTotalCredits = 0;

    const semesterRows = document.querySelectorAll('.semester-row');
    for (const row of semesterRows) {
      const gpaStr = row.querySelector('.sem-gpa').value.trim();
      const creditsStr = row.querySelector('.sem-credits').value.trim();

      // Skip rows that are completely empty
      if (gpaStr === '' && creditsStr === '') continue;

      const gpa = parseFloat(gpaStr);
      const credits = parseFloat(creditsStr);

      // If partially filled or invalid, error
      if (isNaN(gpa) || isNaN(credits) || credits < 0) {
        return { error: "Please ensure all past semester rows are either fully empty or have valid GPA and Credits (Credits ≥ 0)." };
      }

      if (credits === 0) continue; // credit 0 rows have no effect
      prevTotalGpXCh += gpa * credits;
      prevTotalCredits += credits;
    }

    let semTotalGpXCh = 0;
    let semTotalCredits = 0;
    let highestCreditCourse = { name: null, credits: 0 };

    const courseRows = document.querySelectorAll('.course-row');
    if (courseRows.length === 0) {
      return { error: "Please add at least one current course." };
    }

    for (const row of courseRows) {
      const creditHoursInput = row.querySelector('.credit-hours');
      const gradeSelect = row.querySelector('.grade-input');
      const courseNameInput = row.querySelector('.course-name');

      const creditHours = parseFloat(creditHoursInput.value);
      const grade = gradeSelect.value;
      const courseName = courseNameInput.value || "This Course";

      if (creditHours === 0) continue;
      if (isNaN(creditHours) || creditHours < 0 || !grade) {
        return { error: "Please enter a valid number for credit hours (≥ 0) and select a grade for each course." };
      }

      const gp = gradePoints[grade];
      semTotalGpXCh += gp * creditHours;
      semTotalCredits += creditHours;

      if (creditHours > highestCreditCourse.credits) {
        highestCreditCourse.credits = creditHours;
        highestCreditCourse.name = courseName;
      }
    }

    if (semTotalCredits === 0) {
      return { error: "All current courses have 0 credits. Add at least one course with credits to calculate." };
    }

    const semGpa = semTotalGpXCh / semTotalCredits;
    const cumulativeGpXCh = prevTotalGpXCh + semTotalGpXCh;
    const cumulativeCredits = prevTotalCredits + semTotalCredits;
    const newCgpa = cumulativeGpXCh / cumulativeCredits;

    return { semGpa, newCgpa, prevTotalCredits, prevTotalGpXCh, semTotalCredits, highestCreditCourse };
  }

  calculateBtn.addEventListener('click', () => {
    const result = performCalculations();
    if (result.error) { showMessage("Input Error", result.error); return; }

    semGpaResult.textContent = result.semGpa.toFixed(2);
    cgpaResult.textContent = result.newCgpa.toFixed(2);

    const targetCgpa = parseFloat(targetCgpaInput.value);
    if (!isNaN(targetCgpa)) {
      if (result.prevTotalCredits === 0) {
        requiredGpaResult.textContent = 'N/A';
        insightsText.textContent = "To set a target, enter at least one past semester. With no past credits, your target CGPA equals this semester’s GPA.";
      } else {
        const requiredTotalGpXCh = targetCgpa * (result.prevTotalCredits + result.semTotalCredits);
        const requiredSemGpXCh = requiredTotalGpXCh - result.prevTotalGpXCh;
        const requiredGpa = requiredSemGpXCh / result.semTotalCredits;

        if (requiredGpa > 4.0 || requiredGpa < 0) {
          if (result.newCgpa >= targetCgpa) {
            requiredGpaResult.textContent = 'Achieved!';
            insightsText.textContent = `🎉 You already meet or exceed your target CGPA of ${targetCgpa.toFixed(2)}. Keep prioritizing high-credit courses like '${result.highestCreditCourse.name}'.`;
          } else {
            requiredGpaResult.textContent = 'Impossible';
            insightsText.textContent = `Given current credits, it’s not mathematically possible to reach a ${targetCgpa.toFixed(2)} target this term. Still, maximize gains in '${result.highestCreditCourse.name}'.`;
          }
        } else {
          requiredGpaResult.textContent = requiredGpa.toFixed(2);
          insightsText.textContent = `To reach a ${targetCgpa.toFixed(2)} CGPA, aim for at least ${requiredGpa.toFixed(2)} this semester. Focus on '${result.highestCreditCourse.name}' (highest credits).`;
        }
      }
    } else {
      requiredGpaResult.textContent = '--';
      if (result.highestCreditCourse.name) {
        insightsText.textContent = `Biggest impact: '${result.highestCreditCourse.name}' (${result.highestCreditCourse.credits} credits).`;
      } else {
        insightsText.textContent = `To maximize your CGPA, ensure you do well in all your courses. Every grade counts!`;
      }
    }

    if (result.prevTotalCredits > 0) {
      projectionsSection.classList.remove('hidden');
      const futureCredits = result.semTotalCredits;
      const calc = (g) => {
        const futureGpXCh = g * futureCredits;
        const totalGpXCh = result.prevTotalGpXCh + futureGpXCh;
        const totalCredits = result.prevTotalCredits + futureCredits;
        return (totalGpXCh / totalCredits).toFixed(2);
      };
      proj25Result.textContent = calc(2.5);
      proj30Result.textContent = calc(3.0);
      proj35Result.textContent = calc(3.5);
      proj40Result.textContent = calc(4.0);
    } else {
      projectionsSection.classList.add('hidden');
    }

    resultsSection.classList.remove('hidden');
    resultsSection.scrollIntoView({ behavior: 'smooth' });
  });

  whatIfBtn.addEventListener('click', () => {
    const result = performCalculations();
    if (result.error) { showMessage("Input Error", result.error); return; }
    whatIfSemGpa.textContent = result.semGpa.toFixed(2);
    whatIfCgpa.textContent = result.newCgpa.toFixed(2);
    whatIfResults.classList.remove('hidden');
    whatIfResults.scrollIntoView({ behavior: 'smooth' });
  });
</script>
</body>
</html>
